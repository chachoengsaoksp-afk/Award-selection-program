<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; background: #fff7f2; color: #1f2937; }
    .glass { background: rgba(255,255,255,0.9); border: 1px solid rgba(249,115,22,0.08); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .tab-active { background: linear-gradient(90deg,#fb923c,#fb6b2a); color: white; }
    .podium-1 { background: linear-gradient(180deg,#fff3e0,#ffd54f); }
    .podium-2 { background: linear-gradient(180deg,#f5f5f5,#cfcfcf); }
    .podium-3 { background: linear-gradient(180deg,#fff0e6,#e0a96a); }
    .orange-txt { color: #fb6b2a; font-weight:700; }
    @media (max-width:640px) { .podium-grid { flex-direction: column; gap: 12px; } }
  </style>
</head>
<body class="p-6">

<!-- LOGIN -->
<div id="loginBox" class="max-w-md mx-auto mt-8 glass rounded-xl p-6">
  <h2 class="text-2xl font-bold mb-4 text-center orange-txt">üéì ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</h2>
  <input id="user" placeholder="Username" class="w-full p-3 rounded-md border mb-3" />
  <input id="pass" type="password" placeholder="Password" class="w-full p-3 rounded-md border mb-4" />
  <button onclick="login()" class="w-full bg-gradient-to-r from-orange-400 to-orange-600 text-white font-semibold p-3 rounded-md">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- MAIN -->
<div id="mainBox" class="hidden max-w-7xl mx-auto space-y-6">

  <div class="glass rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-bold orange-txt">Dashboard ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
      <p class="text-sm text-gray-600">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>
    </div>
    <div class="flex gap-2">
      <button onclick="downloadPDF()" class="px-3 py-2 rounded-md border bg-white text-orange-600">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
      <button id="btnShowAnn" onclick="openAnnouncementPanel()" class="px-3 py-2 rounded-md bg-orange-500 text-white">üéâ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•</button>
      <button onclick="showAdminLogin()" class="px-3 py-2 rounded-md border bg-white text-orange-600">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏ì‡∏ë‡πå</button>
      <button onclick="logout()" class="px-3 py-2 rounded-md border bg-white">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-6">

    <div class="glass rounded-xl p-6">
      <h3 class="font-semibold mb-3 orange-txt">üìù ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
      <label class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
      <select id="candidate" class="w-full p-3 rounded-md border my-3" onchange="showInfo()"></select>

      <div id="infoBox" class="hidden bg-orange-50 p-3 rounded-md mb-3">
        <p><b>‡∏ä‡∏∑‡πà‡∏≠:</b> <span id="infoName"></span></p>
        <p><b>‡∏ú‡∏•‡∏á‡∏≤‡∏ô:</b> <span id="infoWork"></span></p>
        <p><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> <span id="infoType"></span></p>
      </div>

      <!-- criteria form -->
      <div id="criteriaForm" class="space-y-3 mb-3"></div>

      <div class="flex gap-2 items-center mb-3">
        <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°:</div>
        <div id="totalDisplay" class="text-lg font-bold text-orange-600">0</div>
      </div>

      <button onclick="saveScore()" class="w-full bg-gradient-to-r from-orange-400 to-orange-600 text-white p-3 rounded-md font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>

    <div class="glass rounded-xl p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold orange-txt">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (‡∏£‡∏ß‡∏°)</h3>
        <div class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="totalCount">0</span></div>
      </div>
      <div class="overflow-auto max-h-96">
        <table class="w-full text-left bg-white rounded-md overflow-hidden">
          <thead class="bg-orange-500 text-white">
            <tr>
              <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="text-right">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th class="text-right">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</th><th class="text-center">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="text-center">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
            </tr>
          </thead>
          <tbody id="rankBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="font-bold">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏ì‡∏ë‡πå</h3>
      <button onclick="closeAdminLogin()" class="px-3 py-1 rounded-md border">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div class="p-4">
      <input id="adminUser" placeholder="Username" class="w-full p-2 border rounded-md mb-3">
      <input id="adminPass" type="password" placeholder="Password" class="w-full p-2 border rounded-md mb-3">
      <div class="flex gap-2 justify-end">
        <button onclick="adminLogin()" class="px-4 py-2 bg-orange-500 text-white rounded-md">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>
</div>

<!-- criteria manager modal -->
<div id="criteriaModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b">
      <div><h3 class="font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î) ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3><p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å%</p></div>
      <div class="flex gap-2">
        <button onclick="closeCriteriaManager()" class="px-3 py-2 border rounded-md">‡∏õ‡∏¥‡∏î</button>
        <button onclick="saveCriteriaFromUI()" class="px-3 py-2 bg-orange-500 text-white rounded-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå</button>
      </div>
    </div>
    <div class="p-4">
      <label class="block mb-2 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="criteriaType" class="w-full p-2 border rounded-md mb-4" onchange="loadCriteriaForType()"></select>

      <div class="text-sm text-gray-600 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: **‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 100%**</div>
      <div id="criteriaRows" class="space-y-2"></div>

      <div class="mt-4">
        <button onclick="addCriteriaRow()" class="px-3 py-2 bg-gray-100 rounded-md">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- announcement panel -->
<div id="announcementPanel" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h2 class="text-xl font-bold orange-txt">üé§ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏• ‚Äî ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h2>
        <p class="text-sm text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</p>
      </div>
      <div class="flex gap-2">
        <button onclick="closeAnnouncementPanel()" class="px-3 py-2 rounded-md border">‡∏õ‡∏¥‡∏î</button>
        <button onclick="downloadPDF()" class="px-3 py-2 rounded-md bg-orange-500 text-white">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
      </div>
    </div>

    <div class="p-4">
      <div id="tabsHeader" class="flex gap-2 overflow-x-auto pb-4"></div>
      <div id="tabsContent" class="mt-2"></div>
    </div>
  </div>
</div>

<script>
/* ========== utility ========== */
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

/* ========== state ========== */
let currentUser=""; let candidates=[]; let rankingData=[]; let criteriaList=[];

/* ========== Login (judge) ========== */
function login(){
  const u = (document.getElementById('user').value || "").toString().trim();
  const p = (document.getElementById('pass').value || "").toString().trim();
  if(!u||!p) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞ password");
  google.script.run.withSuccessHandler(function(res){
    if(res && res.success){
      currentUser = res.name;
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('mainBox').classList.remove('hidden');
      loadCandidates(); loadAllCriteria(); loadRanking();
    } else { alert(res && res.message ? res.message : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
  }).checkLogin(u,p);
}
function logout(){ location.reload(); }

/* ========== Candidates ========== */
function loadCandidates(){
  google.script.run.withSuccessHandler(function(data){
    candidates = data || [];
    const sel = document.getElementById('candidate');
    sel.innerHTML = "<option value=''>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ --</option>";
    for(let i=0;i<candidates.length;i++){
      const c=candidates[i];
      const opt=document.createElement('option'); opt.value=i; opt.innerText= (c.name || "") + (c.type?(" ‚Äî "+c.type):''); sel.appendChild(opt);
    }
  }).getCandidates();
}
function showInfo(){
  const idx = document.getElementById('candidate').value;
  if(idx === ""){ document.getElementById('infoBox').classList.add('hidden'); document.getElementById('criteriaForm').innerHTML=''; document.getElementById('totalDisplay').innerText='0'; return; }
  const c = candidates[Number(idx)];
  document.getElementById('infoBox').classList.remove('hidden');
  document.getElementById('infoName').innerText = c.name || "";
  document.getElementById('infoWork').innerText = c.work || "";
  document.getElementById('infoType').innerText = c.type || "";
  renderCriteriaFormForType(c.type);
}

/* ========== Criteria (client) ========== */
function loadAllCriteria(){
  google.script.run.withSuccessHandler(function(data){
    criteriaList = data || [];
    populateCriteriaTypeSelect();
  }).getCriteria();
}
function populateCriteriaTypeSelect(){
  const sel = document.getElementById('criteriaType');
  sel.innerHTML = "<option value=''>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>";
  const types = Array.from(new Set(criteriaList.map(c=>c.type).concat(candidates.map(x=>x.type))));
  types.forEach(function(t){ if(!t) return; const opt=document.createElement('option'); opt.value=t; opt.innerText=t; sel.appendChild(opt); });
}

/* ========== Admin login flow ========== */
function showAdminLogin(){ document.getElementById('adminLoginModal').classList.remove('hidden'); }
function closeAdminLogin(){ document.getElementById('adminLoginModal').classList.add('hidden'); }
function adminLogin(){
  const u = (document.getElementById('adminUser').value||'').toString().trim();
  const p = (document.getElementById('adminPass').value||'').toString().trim();
  if(!u||!p) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏ì‡∏ë‡πå');
  google.script.run.withSuccessHandler(function(res){
    if(res && res.status){
      document.getElementById('adminLoginModal').classList.add('hidden');
      openCriteriaManager();
    } else {
      alert(res && res.message ? res.message : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }).adminLogin(u,p);
}

/* ========== Criteria Manager UI ========== */
function openCriteriaManager(){
  populateCriteriaTypeSelect();
  document.getElementById('criteriaRows').innerHTML = '';
  document.getElementById('criteriaModal').classList.remove('hidden');
}
function closeCriteriaManager(){ document.getElementById('criteriaModal').classList.add('hidden'); }

function loadCriteriaForType(){
  const type = document.getElementById('criteriaType').value;
  const rowsDiv = document.getElementById('criteriaRows');
  rowsDiv.innerHTML = '';
  const rows = criteriaList.filter(c => c.type === type);
  if(rows.length === 0){
    addCriteriaRow();
    return;
  }
  rows.forEach(function(r){
    const wrapper = document.createElement('div'); wrapper.className = 'flex gap-2 items-center';
    const name = document.createElement('input'); name.className='flex-1 p-2 border rounded-md'; name.value = r.name;
    const max = document.createElement('input'); max.type='number'; max.className='w-28 p-2 border rounded-md'; max.value = r.max || 0;
    const weight = document.createElement('input'); weight.type='number'; weight.className='w-28 p-2 border rounded-md'; weight.value = r.weight || 0;
    const del = document.createElement('button'); del.className='px-3 py-2 bg-red-100 rounded-md'; del.innerText='‡∏•‡∏ö';
    del.onclick = function(){ wrapper.remove(); };
    wrapper.appendChild(name);
    wrapper.appendChild(max);
    const wlabel = document.createElement('div'); wlabel.className='text-sm w-20 text-center'; wlabel.innerText='Weight %';
    wrapper.appendChild(wlabel);
    wrapper.appendChild(weight);
    wrapper.appendChild(del);
    rowsDiv.appendChild(wrapper);
  });
}

function addCriteriaRow(){
  const rowsDiv = document.getElementById('criteriaRows');
  const wrapper = document.createElement('div'); wrapper.className = 'flex gap-2 items-center';
  const name = document.createElement('input'); name.className='flex-1 p-2 border rounded-md'; name.placeholder='‡∏ä‡∏∑‡πà‡∏≠/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏±‡∏î';
  const max = document.createElement('input'); max.type='number'; max.className='w-28 p-2 border rounded-md'; max.placeholder='‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î';
  const weight = document.createElement('input'); weight.type='number'; weight.className='w-28 p-2 border rounded-md'; weight.placeholder='Weight%';
  const del = document.createElement('button'); del.className='px-3 py-2 bg-red-100 rounded-md'; del.innerText='‡∏•‡∏ö';
  del.onclick = function(){ wrapper.remove(); };
  const wlabel = document.createElement('div'); wlabel.className='text-sm w-20 text-center'; wlabel.innerText='Weight %';
  wrapper.appendChild(name); wrapper.appendChild(max); wrapper.appendChild(wlabel); wrapper.appendChild(weight); wrapper.appendChild(del);
  rowsDiv.appendChild(wrapper);
}

function saveCriteriaFromUI(){
  const type = document.getElementById('criteriaType').value;
  if(!type) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
  const rowsDiv = document.getElementById('criteriaRows');
  const arr = [];
  let totalWeight = 0;
  rowsDiv.querySelectorAll('div').forEach(function(div){
    const inputsInside = div.querySelectorAll('input');
    // inputsInside: [name, max, weight] or [name, max] depends; we arranged to have 3
    if(inputsInside.length >= 3){
      const nm = inputsInside[0].value || '';
      const mx = Number(inputsInside[1].value) || 0;
      const wt = Number(inputsInside[2].value) || 0;
      if(nm.trim() !== ''){
        arr.push({ name: nm.trim(), max: mx, weight: wt, status: '‡πÄ‡∏õ‡∏¥‡∏î' });
        totalWeight += wt;
      }
    }
  });
  // validate totalWeight == 100 (allow small float tolerance)
  if(arr.length > 0){
    if(Math.abs(totalWeight - 100) > 0.01){
      return alert("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 100% ‚Äî ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏° = " + totalWeight + "%\n‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
    }
  } else {
    return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }

  // call server; server also validates
  google.script.run.withSuccessHandler(function(res){
    if(res && res.success === false){
      alert(res.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
    } else {
      alert((res && res.message) || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      closeCriteriaManager();
      loadAllCriteria();
    }
  }).saveCriteria(type, arr);
}

/* ========== Render scoring form for chosen candidate type ========== */
function renderCriteriaFormForType(type){
  const container = document.getElementById('criteriaForm');
  container.innerHTML = '';
  const list = criteriaList.filter(c => c.type === type);
  if(!list || list.length === 0){
    // legacy single score input
    const wrapper = document.createElement('div');
    wrapper.innerHTML = '<label class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label><input id="legacyScore" type="number" class="w-full p-2 border rounded-md" />';
    container.appendChild(wrapper);
    document.getElementById('totalDisplay').innerText = '0';
    return;
  }
  list.forEach(function(c){
    const row = document.createElement('div'); row.className = 'flex items-center gap-2';
    const lbl = document.createElement('div'); lbl.className='w-48 text-sm'; lbl.innerText = c.name + ' (max ' + c.max + ')';
    const inp = document.createElement('input'); inp.type = 'number'; inp.className='flex-1 p-2 border rounded-md'; inp.min = 0; inp.max = c.max; inp.value = 0;
    inp.oninput = computeTotalFromForm;
    inp.dataset.critName = c.name;
    inp.dataset.critMax = c.max;
    inp.dataset.critWeight = c.weight || 0;
    row.appendChild(lbl); row.appendChild(inp);
    container.appendChild(row);
  });
  computeTotalFromForm();
}

function computeTotalFromForm(){
  const container = document.getElementById('criteriaForm');
  let total = 0;
  let usingWeighted = false;
  const inputs = container.querySelectorAll('input[type="number"]');
  inputs.forEach(function(inp){
    const v = Number(inp.value) || 0;
    const max = Number(inp.dataset.critMax) || 0;
    const wt = Number(inp.dataset.critWeight) || 0;
    if(wt > 0 && max > 0){
      usingWeighted = true;
      total += (v / max) * wt; // weight is percent (0-100)
    } else {
      total += v;
    }
  });
  if(usingWeighted){
    // show as percent with 2 decimals
    document.getElementById('totalDisplay').innerText = (Math.round(total*100)/100).toFixed(2) + ' %';
    // store numeric total (0..100) in dataset for saving
    container.dataset.lastTotal = (Math.round(total*100)/100).toFixed(2);
    container.dataset.weighted = "1";
  } else {
    document.getElementById('totalDisplay').innerText = total;
    container.dataset.lastTotal = total;
    container.dataset.weighted = "0";
  }
}

/* ========== Submit score (collect criteria) ========== */
function saveScore(){
  const idx = document.getElementById('candidate').value;
  if(idx === "") return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£');
  const c = candidates[Number(idx)];
  const container = document.getElementById('criteriaForm');
  const inputs = container.querySelectorAll('input[type="number"]');
  const scoresObj = {};
  let computedTotal = null;
  if(inputs.length === 1 && document.getElementById('legacyScore')){
    const v = Number(document.getElementById('legacyScore').value) || 0;
    scoresObj['score'] = v;
    computedTotal = v;
  } else {
    inputs.forEach(function(inp){
      const name = inp.dataset.critName || ('c' + Math.random());
      const v = Number(inp.value) || 0;
      scoresObj[name] = v;
    });
    computedTotal = container.dataset.lastTotal !== undefined ? Number(container.dataset.lastTotal) : null;
  }
  const payload = { judge: currentUser || '‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£', name: c.name, work: c.work, type: c.type, scores: scoresObj };
  if(computedTotal !== null) payload.total = computedTotal;
  google.script.run.withSuccessHandler(function(res){ alert(res); loadRanking(); document.getElementById('totalDisplay').innerText='0'; }).submitScore(payload);
}

/* ========== Ranking (main table) ========= */
function loadRanking(){ google.script.run.withSuccessHandler(function(data){ rankingData = data || []; renderMainRankTable(rankingData); document.getElementById('totalCount').innerText = rankingData.length; }).getFullRanking(); }
function renderMainRankTable(data){
  const tbody = document.getElementById('rankBody'); tbody.innerHTML = '';
  if(!data || data.length === 0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=6; td.className='p-4 text-center text-gray-600'; td.innerText='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; tr.appendChild(td); tbody.appendChild(tr); return; }
  data.forEach(function(r){
    const tr=document.createElement('tr'); tr.className='border-b';
    const tdType=document.createElement('td'); tdType.className='p-3'; tdType.innerText = escapeHtml(r[0]); tr.appendChild(tdType);
    const tdName=document.createElement('td'); tdName.className='p-3'; tdName.innerText = escapeHtml(r[1]); tr.appendChild(tdName);
    const tdAvg=document.createElement('td'); tdAvg.className='p-3 text-right'; tdAvg.innerText = (r[2]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' : r[2]); tr.appendChild(tdAvg);
    const tdCount=document.createElement('td'); tdCount.className='p-3 text-right'; tdCount.innerText = (r[3]===''? '' : r[3]); tr.appendChild(tdCount);
    const tdRank=document.createElement('td'); tdRank.className='p-3 text-center font-bold'; tdRank.innerText = (r[4]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' : r[4]); tr.appendChild(tdRank);
    const tdMedal=document.createElement('td'); tdMedal.className='p-3 text-center'; tdMedal.innerText = (r[5]||''); tr.appendChild(tdMedal);
    tbody.appendChild(tr);
  });
}

/* ========== Announcement panel (tabs) ========== */
function openAnnouncementPanel(){ google.script.run.withSuccessHandler(function(data){ rankingData = data || []; if(rankingData.length === 0){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö'); return; } buildAnnouncementTabs(rankingData); document.getElementById('announcementPanel').classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); }).getFullRanking(); }
function closeAnnouncementPanel(){ document.getElementById('announcementPanel').classList.add('hidden'); document.getElementById('tabsHeader').innerHTML=''; document.getElementById('tabsContent').innerHTML=''; document.getElementById('btnShowAnn').focus(); }

function buildAnnouncementTabs(data){
  const grouped={};
  for(let i=0;i<data.length;i++){ const row=data[i]; const type=row[0]||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'; if(!grouped[type]) grouped[type]=[]; grouped[type].push(row); }
  const types=Object.keys(grouped);
  types.forEach(function(t){ grouped[t].sort(function(a,b){ return (parseFloat(b[2])||-1) - (parseFloat(a[2])||-1); }); });
  const header=document.getElementById('tabsHeader'); const content=document.getElementById('tabsContent'); header.innerHTML=''; content.innerHTML='';
  types.forEach(function(type, idx){
    const btn=document.createElement('button'); btn.type='button'; btn.className='px-4 py-2 rounded-full border text-sm'; btn.innerText = type + ' (' + grouped[type].length + ')'; btn.dataset.idx=idx; btn.onclick=function(){ activateTab(idx); }; header.appendChild(btn);
    const pane=document.createElement('div'); pane.id='pane-'+idx; pane.className='tab-pane hidden mt-4';
    // podium
    const podiumDiv=document.createElement('div'); podiumDiv.className='flex podium-grid gap-4 items-end justify-center mb-6';
    const top=grouped[type].slice(0,3);
    // second
    const col2=document.createElement('div'); col2.className='w-full md:w-1/3 text-center';
    if(top[1]){ const card=document.createElement('div'); card.className='p-4 rounded-md podium-2'; card.innerHTML = '<div class="text-sm">2</div><div class="text-lg font-bold">'+escapeHtml(top[1][1])+'</div><div class="text-sm">'+(top[1][2]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': escapeHtml(top[1][2]) + ' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô')+'</div>'; col2.appendChild(card); }
    podiumDiv.appendChild(col2);
    // first
    const col1=document.createElement('div'); col1.className='w-full md:w-1/3 text-center';
    if(top[0]){ const card=document.createElement('div'); card.className='p-6 rounded-md podium-1'; card.innerHTML = '<div class="text-sm">1</div><div class="text-2xl font-bold">'+escapeHtml(top[0][1])+'</div><div class="text-sm">'+(top[0][2]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': escapeHtml(top[0][2]) + ' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô')+'</div>'; col1.appendChild(card); }
    podiumDiv.appendChild(col1);
    // third
    const col3=document.createElement('div'); col3.className='w-full md:w-1/3 text-center';
    if(top[2]){ const card=document.createElement('div'); card.className='p-4 rounded-md podium-3'; card.innerHTML = '<div class="text-sm">3</div><div class="text-lg font-bold">'+escapeHtml(top[2][1])+'</div><div class="text-sm">'+(top[2][2]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': escapeHtml(top[2][2]) + ' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô')+'</div>'; col3.appendChild(card); }
    podiumDiv.appendChild(col3);
    pane.appendChild(podiumDiv);
    // full table
    const wrap=document.createElement('div'); wrap.className='overflow-auto max-h-96 bg-white rounded-md p-3';
    const table=document.createElement('table'); table.className='w-full text-left';
    const thead=document.createElement('thead'); thead.innerHTML = "<tr class='bg-orange-500 text-white'><th class='p-2 w-20'>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th class='p-2'>‡∏ä‡∏∑‡πà‡∏≠</th><th class='p-2 text-right w-36'>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th class='p-2 text-right w-36'>‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</th><th class='p-2 text-center w-28'>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th></tr>";
    table.appendChild(thead);
    const tbody=document.createElement('tbody');
    grouped[type].forEach(function(r){ const tr=document.createElement('tr'); tr.className='border-t'; const tdRank=document.createElement('td'); tdRank.className='p-2'; tdRank.innerText = (r[4]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': r[4]); const tdName=document.createElement('td'); tdName.className='p-2'; tdName.innerText = r[1]; const tdAvg=document.createElement('td'); tdAvg.className='p-2 text-right'; tdAvg.innerText = (r[2]===''? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': r[2]); const tdCount=document.createElement('td'); tdCount.className='p-2 text-right'; tdCount.innerText = (r[3]===''? '': r[3]); const tdMedal=document.createElement('td'); tdMedal.className='p-2 text-center'; tdMedal.innerText = (r[5]||''); tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdAvg); tr.appendChild(tdCount); tr.appendChild(tdMedal); tbody.appendChild(tr); });
    table.appendChild(tbody); wrap.appendChild(table); pane.appendChild(wrap);
    content.appendChild(pane);
  });
  if(types.length>0) activateTab(0);
}
function activateTab(i){ const header=document.getElementById('tabsHeader'); const buttons=header.querySelectorAll('button'); buttons.forEach((b,idx)=>{ if(idx===i){ b.classList.add('tab-active'); b.classList.remove('border'); } else { b.classList.remove('tab-active'); b.classList.add('border'); } }); const panes=document.querySelectorAll('.tab-pane'); panes.forEach((p,idx)=>{ if(idx===i) p.classList.remove('hidden'); else p.classList.add('hidden'); }); }

/* ========== PDF ========= */
function downloadPDF(){ google.script.run.withSuccessHandler(function(url){ if(url) window.open(url,'_blank'); else alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ'); }).exportPDF(); }

/* ========== init ========= */
document.addEventListener('DOMContentLoaded', function(){ const u=document.getElementById('user'); if(u) u.focus(); loadAllCriteria(); });
</script>

</body>
</html>
