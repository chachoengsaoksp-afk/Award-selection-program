<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; }
    .bg-orange { background: linear-gradient(135deg, #FF8C00, #E65100); color: white; }
    .btn-orange { background-color: #FF8C00; color: white; border-radius: 50px; }
    .btn-orange:hover { background-color: #E65100; color: white; }
    
    /* สไตล์สำหรับเมนู Tab */
    .nav-pills .nav-link { color: #E65100; font-weight: 600; border: 1px solid #FF8C00; margin: 0 5px; }
    .nav-pills .nav-link.active { background-color: #FF8C00; color: white; border: none; }
    
    .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    #login-page { background: #FF8C00; height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; width: 100%; z-index: 9999; top:0; left:0; }
    #main-content { display: none; }

    /* การจัดการหน้าพิมพ์ */
    @media print {
      .no-print, .nav, .navbar, .btn, .swal2-container { display: none !important; }
      #main-content { display: block !important; }
      .tab-pane { display: none !important; }
      .tab-pane.active { display: block !important; }
      .card { box-shadow: none !important; border: 1px solid #ccc !important; }
      body { background-color: white !important; padding: 0; }
    }
  </style>
</head>
<body>

<div id="login-page">
  <div class="card p-4 shadow-lg text-center" style="width: 350px;">
    <h4 class="fw-bold mb-4" style="color: #E65100;">เข้าสู่ระบบกรรมการ</h4>
    <form onsubmit="handleLogin(event)">
      <div class="mb-3 text-start">
        <label class="form-label small">ชื่อผู้ใช้งาน</label>
        <input type="text" id="user" class="form-control" required>
      </div>
      <div class="mb-4 text-start">
        <label class="form-label small">รหัสผ่าน</label>
        <input type="password" id="pass" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-orange w-100 py-2 fw-bold">Login</button>
    </form>
  </div>
</div>

<div id="main-content">
  <nav class="navbar bg-orange shadow-sm px-4 no-print">
    <span class="navbar-brand mb-0 h1 text-white fw-bold">KSP CHACHOENGSAO</span>
    <button class="btn btn-sm btn-outline-light" onclick="location.reload()">ออกจากระบบ</button>
  </nav>

  <div class="container mt-4">
    <ul class="nav nav-pills nav-justified mb-4 no-print" id="pills-tab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="btn-form" data-bs-toggle="pill" data-bs-target="#tab-form" type="button">
          <i class="bi bi-pencil-square"></i> บันทึกคะแนน
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="btn-result" data-bs-toggle="pill" data-bs-target="#tab-result" type="button" onclick="loadResults()">
          <i class="bi bi-table"></i> สรุปผล (ชีต6)
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="tab-form" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-md-8">
            <form id="scoreForm" onsubmit="handleFormSubmit(event)">
              <input type="hidden" id="judgeName" name="judgeName">
              <div class="card p-4 mb-3">
                <h5 class="fw-bold mb-3 border-bottom pb-2 text-orange">1. ข้อมูลผู้สมัคร</h5>
                <input class="form-control form-control-lg mb-3" list="namesList" id="nameInput" placeholder="พิมพ์ชื่อเพื่อค้นหา..." onchange="onNameChange()" required>
                <datalist id="namesList"></datalist>
                <div class="row">
                  <div class="col-6"><label class="small">วิชาชีพ</label><input type="text" id="professionType" name="professionType" class="form-control bg-light" readonly></div>
                  <div class="col-6"><label class="small">ผลงาน</label><input type="text" id="workName" name="workName" class="form-control bg-light" readonly></div>
                </div>
                <input type="hidden" id="applicantName" name="applicantName">
              </div>

              <div class="card p-4 mb-4">
                <h5 class="fw-bold mb-3 border-bottom pb-2 text-orange">2. บันทึกคะแนน</h5>
                <div class="row g-2">
                  <div class="col-4">ด้าน 1<input type="number" class="form-control" name="score1" min="0" max="20" oninput="updateTotal()"></div>
                  <div class="col-4">ด้าน 2<input type="number" class="form-control" name="score2" min="0" max="20" oninput="updateTotal()"></div>
                  <div class="col-4">ด้าน 3<input type="number" class="form-control" name="score3" min="0" max="20" oninput="updateTotal()"></div>
                  <div class="col-4">ด้าน 4<input type="number" class="form-control" name="score4" min="0" max="20" oninput="updateTotal()"></div>
                  <div class="col-4">ด้าน 5<input type="number" class="form-control" name="score5" min="0" max="20" oninput="updateTotal()"></div>
                  <div class="col-4 text-center">รวม<div id="totalDisplay" class="h3 fw-bold text-danger">0</div></div>
                </div>
              </div>
              <button type="submit" class="btn btn-orange w-100 py-3 fw-bold shadow">บันทึกข้อมูล</button>
            </form>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-result" role="tabpanel">
        <div class="card p-4 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3 no-print">
            <h5 class="fw-bold text-orange m-0">ตารางสรุปผลการคัดเลือก</h5>
            <button class="btn btn-dark" onclick="window.print()"><i class="bi bi-printer"></i> พิมพ์</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr class="text-center"><th>ลำดับ</th><th>ชื่อ-สกุล</th><th>ประเภท</th><th>ผลงาน</th><th>คะแนน</th></tr>
              </thead>
              <tbody id="resultBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let rawData = [];

  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;
    google.script.run.withSuccessHandler(res => {
      if (res.success) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('judgeName').value = res.user;
        loadApplicants();
      } else { Swal.fire('Error', res.message, 'error'); }
    }).checkLogin(u, p);
  }

  function loadApplicants() {
    google.script.run.withSuccessHandler(data => {
      rawData = data;
      const list = document.getElementById('namesList');
      list.innerHTML = '';
      data.forEach(r => { let opt = document.createElement('option'); opt.value = r[0]; list.appendChild(opt); });
    }).getApplicantList();
  }

  function onNameChange() {
    const val = document.getElementById('nameInput').value;
    const found = rawData.find(r => r[0] === val);
    if (found) {
      document.getElementById('applicantName').value = found[0];
      document.getElementById('workName').value = found[1];
      document.getElementById('professionType').value = found[2];
    }
  }

  function updateTotal() {
    let sum = 0;
    document.querySelectorAll('input[type="number"]').forEach(i => sum += (parseFloat(i.value) || 0));
    document.getElementById('totalDisplay').innerText = sum;
  }

  function handleFormSubmit(e) {
    e.preventDefault();
    if(!document.getElementById('applicantName').value) return Swal.fire('คำเตือน', 'กรุณาเลือกรายชื่อผู้สมัคร', 'warning');
    Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
    google.script.run.withSuccessHandler(res => {
      Swal.fire(res.success ? 'สำเร็จ' : 'ผิดพลาด', res.message, res.success ? 'success' : 'error');
      if(res.success) { e.target.reset(); document.getElementById('totalDisplay').innerText = '0'; }
    }).processForm(e.target);
  }

  function loadResults() {
    const body = document.getElementById('resultBody');
    body.innerHTML = '<tr><td colspan="5" class="text-center">กำลังดึงข้อมูล...</td></tr>';
    google.script.run.withSuccessHandler(data => {
      body.innerHTML = '';
      data.forEach(r => {
        body.innerHTML += `<tr class="text-center"><td>${r[0]}</td><td class="text-start">${r[1]}</td><td>${r[2]}</td><td class="text-start small">${r[3]}</td><td class="fw-bold text-danger">${r[4]}</td></tr>`;
      });
    }).getSummaryData();
  }
</script>
</body>
</html>
